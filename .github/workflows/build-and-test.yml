name: Connect IQ Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Connect IQ SDK
      run: |
        # Download Connect IQ SDK
        wget -q https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-lin-7.3.1.zip
        unzip -q connectiq-sdk-lin-7.3.1.zip -d ~/
        echo "CONNECTIQ_SDK_HOME=$HOME/connectiq-sdk-lin-7.3.1" >> $GITHUB_ENV
        echo "$HOME/connectiq-sdk-lin-7.3.1/bin" >> $GITHUB_PATH

    - name: Verify SDK Installation
      run: |
        monkeyc --version

    - name: Build Main Application
      run: |
        echo "Building main application..."
        monkeyc \
          -o build/meshtastic.prg \
          -f monkey.jungle \
          -d fenix8_51mm \
          -w

    - name: Build Comprehensive Tests
      run: |
        echo "Building comprehensive test suite..."
        monkeyc \
          -o build/comprehensive-test.prg \
          -f comprehensive-test.jungle \
          -d fenix8_51mm \
          -w

    - name: Run Tests in Simulator
      run: |
        echo "Running tests..."
        # Note: Full simulator testing requires graphics environment
        # For CI, we primarily validate compilation
        echo "✅ Compilation successful - tests built"

    - name: Build Summary
      run: |
        echo "=== Build Summary ==="
        echo "✅ Main application compiled successfully"
        echo "✅ Test suite compiled successfully"
        ls -lh build/

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/*.prg
        retention-days: 7

  static-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Count Lines of Code
      run: |
        echo "=== Code Statistics ==="
        echo "Source files:"
        find src/ -name "*.mc" -type f | wc -l
        echo "Test files:"
        find tests/ -name "*.mc" -type f | wc -l
        echo "Total lines:"
        find src/ tests/ -name "*.mc" -type f -exec wc -l {} + | tail -1

    - name: Check for TODO comments
      run: |
        echo "=== TODO Comments ==="
        grep -r "TODO" src/ tests/ || echo "No TODOs found"

    - name: Validate Jungle Files
      run: |
        echo "=== Jungle File Validation ==="
        for f in *.jungle; do
          echo "Checking $f..."
          grep -q "project.manifest" "$f" && echo "✅ $f" || echo "❌ $f missing manifest"
        done
