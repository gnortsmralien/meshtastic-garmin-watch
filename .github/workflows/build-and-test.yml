name: Connect IQ Build and Test

on:
  push:
    branches: [ master, main, 'claude/**' ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Connect IQ SDK
      run: |
        # Install jq for JSON parsing
        sudo apt-get update -qq
        sudo apt-get install -y -qq jq

        # Download Connect IQ SDK - fetch latest version from Garmin
        GMNDL=https://developer.garmin.com/downloads/connect-iq/sdks
        wget -q $GMNDL/sdks.json

        # Get the latest Linux SDK filename
        SDK=$(jq -r '.[].linux' sdks.json | grep -v null | sort -V | tail -1)
        echo "Downloading SDK: $SDK"

        # Download and extract SDK
        # Note: The SDK zip extracts directly to ~/bin/, ~/lib/, etc.
        wget -q -O ciq.zip $GMNDL/$SDK
        unzip -q ciq.zip -d ~/

        # Verify extraction
        echo "SDK extracted to home directory"
        ls -la ~/bin/monkeyc || echo "ERROR: monkeyc not found"

        # Set environment variables
        # The SDK extracts to $HOME/bin, $HOME/lib, etc.
        echo "CONNECTIQ_SDK_HOME=$HOME" >> $GITHUB_ENV
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Verify SDK Installation
      run: |
        echo "Verifying SDK installation..."
        which monkeyc
        monkeyc --version

    - name: Setup Device Files
      run: |
        # Copy bundled device files to SDK's expected location
        # On Linux, the SDK looks for devices in ~/.Garmin/ConnectIQ/Devices/
        echo "Setting up fenix8solar51mm device files..."
        mkdir -p $HOME/.Garmin/ConnectIQ/Devices
        cp -r .connectiq/Devices/fenix8solar51mm $HOME/.Garmin/ConnectIQ/Devices/
        echo "Device files installed:"
        ls -la $HOME/.Garmin/ConnectIQ/Devices/fenix8solar51mm/

    - name: Generate Developer Key
      run: |
        echo "Generating temporary developer key for CI builds..."
        # Generate RSA key and convert to PKCS8 DER format (required by Garmin SDK)
        openssl genrsa -out developer_key.pem 4096 2>/dev/null
        openssl pkcs8 -topk8 -inform PEM -outform DER -in developer_key.pem -out developer_key -nocrypt
        rm developer_key.pem
        echo "Developer key generated in PKCS8 format"

    - name: Build Main Application
      run: |
        echo "Building main application..."
        mkdir -p build
        monkeyc \
          -o build/meshtastic.prg \
          -f monkey.jungle \
          -d fenix8solar51mm \
          -y developer_key \
          -w

    - name: Build Comprehensive Tests
      run: |
        echo "Building comprehensive test suite..."
        monkeyc \
          -o build/comprehensive-test.prg \
          -f comprehensive-test.jungle \
          -d fenix8solar51mm \
          -y developer_key \
          -w

    - name: Run Tests in Simulator
      run: |
        echo "Running tests..."
        # Note: Full simulator testing requires graphics environment
        # For CI, we primarily validate compilation
        echo "✅ Compilation successful - tests built"

    - name: Build Summary
      run: |
        echo "=== Build Summary ==="
        echo "✅ Main application compiled successfully"
        echo "✅ Test suite compiled successfully"
        ls -lh build/

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/*.prg
        retention-days: 7

  static-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Count Lines of Code
      run: |
        echo "=== Code Statistics ==="
        echo "Source files:"
        find src/ -name "*.mc" -type f | wc -l
        echo "Test files:"
        find tests/ -name "*.mc" -type f | wc -l
        echo "Total lines:"
        find src/ tests/ -name "*.mc" -type f -exec wc -l {} + | tail -1

    - name: Check for TODO comments
      run: |
        echo "=== TODO Comments ==="
        grep -r "TODO" src/ tests/ || echo "No TODOs found"

    - name: Validate Jungle Files
      run: |
        echo "=== Jungle File Validation ==="
        for f in *.jungle; do
          echo "Checking $f..."
          grep -q "project.manifest" "$f" && echo "✅ $f" || echo "❌ $f missing manifest"
        done
