name: Connect IQ Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Connect IQ SDK
      run: |
        # Install jq for JSON parsing
        sudo apt-get update -qq
        sudo apt-get install -y -qq jq

        # Download Connect IQ SDK - fetch latest version from Garmin
        GMNDL=https://developer.garmin.com/downloads/connect-iq/sdks
        wget -q $GMNDL/sdks.json

        # Get the latest Linux SDK filename
        SDK=$(jq -r '.[].linux' sdks.json | grep -v null | sort -V | tail -1)
        echo "Downloading SDK: $SDK"

        # Download and extract SDK
        # Note: The SDK zip extracts directly to ~/bin/, ~/lib/, etc.
        wget -q -O ciq.zip $GMNDL/$SDK
        unzip -q ciq.zip -d ~/

        # Verify extraction
        echo "SDK extracted to home directory"
        ls -la ~/bin/monkeyc || echo "ERROR: monkeyc not found"

        # Set environment variables
        # The SDK extracts to $HOME/bin, $HOME/lib, etc.
        echo "CONNECTIQ_SDK_HOME=$HOME" >> $GITHUB_ENV
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Verify SDK Installation
      run: |
        echo "Verifying SDK installation..."
        which monkeyc
        monkeyc --version

    - name: Install SDK Manager CLI and Download Devices
      run: |
        echo "Installing connect-iq-sdk-manager-cli..."
        curl -sL https://raw.githubusercontent.com/lindell/connect-iq-sdk-manager-cli/master/install.sh | sh

        # Add to PATH for this step
        export PATH="$HOME/.local/bin:$PATH"

        echo "Downloading devices from manifest..."
        # Download devices specified in manifest.xml
        connect-iq-sdk-manager device download --manifest=manifest.xml || echo "Device download completed with warnings"

        # Copy bundled device files to SDK location
        echo "Copying bundled fenix8solar51mm device files to SDK..."
        mkdir -p $HOME/Devices
        cp -r .connectiq/Devices/fenix8solar51mm $HOME/Devices/
        ls -la $HOME/Devices/fenix8solar51mm/

    - name: Build Main Application
      run: |
        echo "Building main application..."
        mkdir -p build
        monkeyc \
          -o build/meshtastic.prg \
          -f monkey.jungle \
          -d fenix8solar51mm \
          -w

    - name: Build Comprehensive Tests
      run: |
        echo "Building comprehensive test suite..."
        monkeyc \
          -o build/comprehensive-test.prg \
          -f comprehensive-test.jungle \
          -d fenix8solar51mm \
          -w

    - name: Run Tests in Simulator
      run: |
        echo "Running tests..."
        # Note: Full simulator testing requires graphics environment
        # For CI, we primarily validate compilation
        echo "✅ Compilation successful - tests built"

    - name: Build Summary
      run: |
        echo "=== Build Summary ==="
        echo "✅ Main application compiled successfully"
        echo "✅ Test suite compiled successfully"
        ls -lh build/

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/*.prg
        retention-days: 7

  static-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Count Lines of Code
      run: |
        echo "=== Code Statistics ==="
        echo "Source files:"
        find src/ -name "*.mc" -type f | wc -l
        echo "Test files:"
        find tests/ -name "*.mc" -type f | wc -l
        echo "Total lines:"
        find src/ tests/ -name "*.mc" -type f -exec wc -l {} + | tail -1

    - name: Check for TODO comments
      run: |
        echo "=== TODO Comments ==="
        grep -r "TODO" src/ tests/ || echo "No TODOs found"

    - name: Validate Jungle Files
      run: |
        echo "=== Jungle File Validation ==="
        for f in *.jungle; do
          echo "Checking $f..."
          grep -q "project.manifest" "$f" && echo "✅ $f" || echo "❌ $f missing manifest"
        done
