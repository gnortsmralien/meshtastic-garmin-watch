name: Connect IQ Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Connect IQ SDK
      run: |
        # Install jq for JSON parsing
        sudo apt-get update -qq
        sudo apt-get install -y -qq jq

        # Download Connect IQ SDK - fetch latest version from Garmin
        GMNDL=https://developer.garmin.com/downloads/connect-iq/sdks
        wget -q $GMNDL/sdks.json

        # Get the latest Linux SDK filename
        SDK=$(jq -r '.[].linux' sdks.json | grep -v null | sort -V | tail -1)
        echo "Downloading SDK: $SDK"

        # Download and extract SDK
        wget -q -O ciq.zip $GMNDL/$SDK
        unzip -q ciq.zip -d ~/

        # Extract version directory name (remove .zip extension)
        SDK_DIR=$(basename "$SDK" .zip)
        echo "SDK Directory: $SDK_DIR"

        # Debug: List what was extracted
        echo "Contents of home directory:"
        ls -la ~/ | grep connectiq || echo "No connectiq directory found"

        # Check if bin directory exists
        if [ -d "$HOME/$SDK_DIR/bin" ]; then
          echo "Found bin directory at: $HOME/$SDK_DIR/bin"
          ls -la "$HOME/$SDK_DIR/bin" | head -20
        else
          echo "ERROR: bin directory not found at $HOME/$SDK_DIR/bin"
          echo "Directory structure:"
          find ~/ -maxdepth 3 -name "monkeyc" -o -name "bin" 2>/dev/null
        fi

        # Set environment variables
        echo "CONNECTIQ_SDK_HOME=$HOME/$SDK_DIR" >> $GITHUB_ENV
        echo "$HOME/$SDK_DIR/bin" >> $GITHUB_PATH

    - name: Verify SDK Installation
      run: |
        echo "PATH: $PATH"
        echo "CONNECTIQ_SDK_HOME: $CONNECTIQ_SDK_HOME"
        echo "Checking for monkeyc:"
        which monkeyc || echo "monkeyc not in PATH"
        ls -la "$CONNECTIQ_SDK_HOME/bin/monkeyc" || echo "monkeyc not found at expected location"

        # Try to run monkeyc with full path
        if [ -f "$CONNECTIQ_SDK_HOME/bin/monkeyc" ]; then
          "$CONNECTIQ_SDK_HOME/bin/monkeyc" --version
        else
          echo "ERROR: monkeyc binary not found"
          exit 1
        fi

    - name: Build Main Application
      run: |
        echo "Building main application..."
        mkdir -p build
        monkeyc \
          -o build/meshtastic.prg \
          -f monkey.jungle \
          -d fenix8_51mm \
          -w

    - name: Build Comprehensive Tests
      run: |
        echo "Building comprehensive test suite..."
        monkeyc \
          -o build/comprehensive-test.prg \
          -f comprehensive-test.jungle \
          -d fenix8_51mm \
          -w

    - name: Run Tests in Simulator
      run: |
        echo "Running tests..."
        # Note: Full simulator testing requires graphics environment
        # For CI, we primarily validate compilation
        echo "✅ Compilation successful - tests built"

    - name: Build Summary
      run: |
        echo "=== Build Summary ==="
        echo "✅ Main application compiled successfully"
        echo "✅ Test suite compiled successfully"
        ls -lh build/

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/*.prg
        retention-days: 7

  static-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Count Lines of Code
      run: |
        echo "=== Code Statistics ==="
        echo "Source files:"
        find src/ -name "*.mc" -type f | wc -l
        echo "Test files:"
        find tests/ -name "*.mc" -type f | wc -l
        echo "Total lines:"
        find src/ tests/ -name "*.mc" -type f -exec wc -l {} + | tail -1

    - name: Check for TODO comments
      run: |
        echo "=== TODO Comments ==="
        grep -r "TODO" src/ tests/ || echo "No TODOs found"

    - name: Validate Jungle Files
      run: |
        echo "=== Jungle File Validation ==="
        for f in *.jungle; do
          echo "Checking $f..."
          grep -q "project.manifest" "$f" && echo "✅ $f" || echo "❌ $f missing manifest"
        done
